<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.tena.untact2021.dao.ArticleDao">
    <!-- 게시판 조회 -->
    <select id="findBoard" resultType="Board">
        SELECT *
        FROM board
        WHERE
            id = #{boardId}
    </select>

	<!-- 게시물 조회 -->
	<select id="findById" resultType="Article">
		SELECT *
		FROM article
		WHERE
			id = #{id}
	</select>

    <!-- 게시물 조회 (작성자 정보 포함) -->
    <select id="findForPrintById" resultType="Article">
        SELECT A.*,
               IFNULL(M.nickname, "탈퇴회원") AS extra__writer
        FROM article AS A
        LEFT JOIN `member` AS M
        ON A.memberId = M.id
        WHERE A.id = #{id};
    </select>

	<!-- 전체 게시물 조회 -->
	<!--
	List<Article> findAll(@Param("searchKeywordType") String searchKeywordType, 
						@Param("searchKeyword") String searchKeyword); 
	 -->
	<select id="findAll" resultType="Article">
		SELECT *
		FROM article
		WHERE 1
		<if test='searchKeyword != null and !"".equals(searchKeyword)'>
			<if test="searchKeywordType == @com.tena.untact2021.dto.Search$SearchKeywordType@TITLE">
				AND title LIKE CONCAT('%', #{searchKeyword}, '%')
			</if>
			<if test="searchKeywordType == @com.tena.untact2021.dto.Search$SearchKeywordType@BODY">
				AND `body` LIKE CONCAT('%', #{searchKeyword}, '%')
			</if>
			<if test="searchKeywordType == @com.tena.untact2021.dto.Search$SearchKeywordType@TITLEANDBODY">
				AND (
				title LIKE CONCAT('%', #{searchKeyword}, '%')
				OR
				`body` LIKE CONCAT('%', #{searchKeyword}, '%')
				)
			</if>
		</if>
		ORDER BY id DESC
	</select>

    <!-- 전체 게시물 조회 (작성자 정보 포함) -->
    <select id="findAllForPrint" resultType="Article">
        SELECT A.*,
        IFNULL(M.nickname, "탈퇴회원") AS extra__writer
        FROM article AS A
        LEFT JOIN `member` AS M
        ON A.memberId = M.id
        WHERE 1
        <if test="boardId != null">
            AND A.boardId = #{boardId}
        </if>
        <if test='searchKeyword != null and !"".equals(searchKeyword)'>
            <if test="searchKeywordType == @com.tena.untact2021.dto.Search$SearchKeywordType@TITLE">
                AND A.title LIKE CONCAT('%', #{searchKeyword}, '%')
            </if>
            <if test="searchKeywordType == @com.tena.untact2021.dto.Search$SearchKeywordType@BODY">
                AND A.`body` LIKE CONCAT('%', #{searchKeyword}, '%')
            </if>
            <if test="searchKeywordType == @com.tena.untact2021.dto.Search$SearchKeywordType@TITLEANDBODY">
                AND (
                        A.title LIKE CONCAT('%', #{searchKeyword}, '%')
                    OR
                        A.`body` LIKE CONCAT('%', #{searchKeyword}, '%')
                    )
            </if>
        </if>
        ORDER BY id DESC
        <if test="limitFrom != null and limitTake != null">
            LIMIT #{limitFrom}, #{limitTake}
        </if>
    </select>

	<!-- 게시물 추가 -->
	<insert id="save" useGeneratedKeys="true" keyProperty="id">
		INSERT INTO article
		SET
			regDate = NOW(),
			updateDate = NOW(),
			title = #{title},
			`body` = #{body},
            memberId = #{memberId}
	</insert>

	<!-- 게시물 삭제 -->
	<delete id="deleteById">
		DELETE FROM article
		WHERE
			id = #{id}
	</delete>

	<!-- 게시물 수정 -->
	<update id="update">
		UPDATE article
		<set>
			<if test="title != null or body != null">
				updateDate = NOW(),
			</if>
			<if test="title != null">
				title = #{title},
			</if>
			<if test="body != null">
				`body` = #{body}
			</if>
		</set>
		WHERE id = #{id}
	</update>

    <!-- 댓글 추가 -->
    <insert id="saveReply" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO reply
        SET
            regDate = NOW(),
            updateDate = NOW(),
            articleId = #{articleId},
            `body` = #{body},
            memberId = #{memberId}
    </insert>

</mapper>
